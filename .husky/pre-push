#!/bin/sh

# Exit on any error
set -e

echo "ğŸš€ Running pre-push checks..."

# Check if we're in the right directory
if [ ! -f "package.json" ]; then
    echo "âŒ Error: package.json not found. Are you in the project root?"
    exit 1
fi

echo "ğŸ”’ Running comprehensive security audit..."

# Run npm audit with stricter checks for push
npm audit --audit-level low

if [ $? -eq 0 ]; then
    echo "âœ… Security audit passed! No vulnerabilities found."
else
    echo "âŒ Security vulnerabilities found! Please fix them before pushing."
    echo "ğŸ’¡ Tip: Run 'npm audit fix' to automatically fix issues, or 'npm audit' for details."
    exit 1
fi

echo "ğŸ—ï¸ Running build check..."

# Ensure the project builds successfully before push
npm run build

if [ $? -eq 0 ]; then
    echo "âœ… Build check passed!"
else
    echo "âŒ Build failed! Please fix build errors before pushing."
    exit 1
fi

echo "âœ¨ Pre-push checks passed! Ready to deploy."