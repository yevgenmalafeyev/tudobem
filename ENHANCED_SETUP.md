# Enhanced Question Generation System - Setup Guide\n\n## Overview\n\nThis guide will help you set up the new enhanced question generation system that provides:\n\n- **10x Efficiency**: Batch generation (10 questions per API call vs 1)\n- **Seamless UX**: Background loading eliminates wait times\n- **Persistent Library**: Growing database of questions for all users\n- **Multilingual Support**: Portuguese, English, and Ukrainian explanations\n- **Smart Fallback**: Database-driven question selection when AI unavailable\n\n## Prerequisites\n\n1. **Database Access**: Ensure PostgreSQL database is configured\n2. **Environment Variables**: Set up required environment variables\n3. **Dependencies**: All npm packages installed\n\n## Environment Setup\n\n### Required Environment Variables\n\n```bash\n# Database (required)\nPOSTGRES_URL=\"postgresql://username:password@host:port/database\"\n\n# Anthropic API (optional - for AI generation)\nANTHROPIC_API_KEY=\"your-claude-api-key\"\n\n# Feature Flags (optional)\nFEATURE_ENHANCED_GENERATION=true\nFEATURE_BATCH_MODE=true\nFEATURE_DATABASE_EXERCISES=true\n```\n\n### Vercel Deployment\n\nFor Vercel deployment, add these environment variables in your Vercel dashboard:\n\n1. Go to your project settings\n2. Navigate to \"Environment Variables\"\n3. Add the variables above\n4. Redeploy your application\n\n## Installation Steps\n\n### Step 1: Install Dependencies\n\n```bash\nnpm install\n```\n\n### Step 2: Initialize Enhanced System\n\n```bash\n# Complete setup (database + migration + validation)\nnpm run enhanced:setup\n```\n\nOr run individual steps:\n\n```bash\n# Initialize database tables\nnpm run db:init\n\n# Migrate static exercises to database\nnpm run db:migrate\n\n# Validate migration\nnpm run db:validate\n```\n\n### Step 3: Test the System\n\n```bash\n# Run enhanced system tests\nnpm run enhanced:test\n\n# Run full test suite\nnpm test\n```\n\n### Step 4: Start Development Server\n\n```bash\nnpm run dev\n```\n\n## Verification\n\n### 1. Check Database Health\n\nAfter setup, verify the database contains exercises:\n\n```bash\nnpm run db:validate\n```\n\nExpected output:\n```\n✅ Migration validation passed\n📊 Found exercises for all required levels\n📚 XX static exercises in database\n```\n\n### 2. Test Question Generation\n\n1. Open the application\n2. Look for the status indicator in the top-right corner\n3. Start a learning session\n4. Verify:\n   - Questions load quickly (batch of 10)\n   - Status indicator shows source (🤖 AI Fresh, 📚 Library, etc.)\n   - Background loading triggers at 8/10 progress\n   - Multilingual explanations appear for wrong answers\n\n### 3. Monitor Performance\n\n- **Loading Times**: <200ms between questions\n- **API Calls**: 90% reduction (1 call per 10 questions)\n- **User Experience**: No wait times between questions\n\n## Troubleshooting\n\n### Database Connection Issues\n\n```bash\n# Check database connection\nnode -e \"console.log(process.env.POSTGRES_URL)\"\n\n# Reinitialize database\nnpm run db:init\n```\n\n### Migration Problems\n\n```bash\n# Check current database state\nnpm run db:validate\n\n# Rollback if needed\nnpm run db:rollback\n\n# Re-run migration\nnpm run db:migrate\n```\n\n### Performance Issues\n\n1. **Slow Question Loading**:\n   - Check database connection speed\n   - Verify indexes are created\n   - Monitor API response times\n\n2. **High API Costs**:\n   - Verify batch generation is working (10 questions per call)\n   - Check database is being populated and reused\n   - Monitor status indicator for source type\n\n### Feature Flags\n\nIf you need to disable enhanced features:\n\n```bash\n# Disable enhanced generation\nFEATURE_ENHANCED_GENERATION=false\n\n# Disable batch mode\nFEATURE_BATCH_MODE=false\n\n# Disable database exercises\nFEATURE_DATABASE_EXERCISES=false\n```\n\n## Usage Guide\n\n### For Users\n\n1. **Status Indicator**: Click the top-right indicator to see generation details\n2. **Question Sources**:\n   - 🤖 **AI Fresh**: Newly generated by Claude AI\n   - 📚 **Library**: From curated question database\n   - 🔄 **Mixed**: Combination of AI and database\n   - 🔄 **Offline**: Static questions (fallback mode)\n\n3. **Background Loading**: Questions load automatically as you progress\n\n### For Developers\n\n1. **API Endpoints**:\n   - `/api/generate-exercise-batch`: Batch generation (new)\n   - `/api/generate-exercise`: Single exercise (legacy, enhanced)\n\n2. **Database Tables**:\n   - `exercises`: Main exercise storage\n   - `exercise_sessions`: Usage tracking\n   - `generation_queue`: Background processing\n\n3. **Key Services**:\n   - `ExerciseDatabase`: Database operations\n   - `EnhancedFallbackService`: Smart fallback logic\n   - `ExerciseQueueService`: Background processing\n   - `useExerciseQueue`: Frontend queue management\n\n## Maintenance\n\n### Regular Tasks\n\n```bash\n# Check database health (weekly)\nnpm run db:validate\n\n# Run enhanced system tests (before deployments)\nnpm run enhanced:test\n\n# Monitor queue processing (check logs)\n```\n\n### Database Maintenance\n\n- **Exercise Cleanup**: Old sessions are automatically cleaned up\n- **Usage Statistics**: Monitor via `ExerciseDatabase.getUsageStats()`\n- **Performance**: Database queries are optimized with proper indexes\n\n## Migration from Legacy System\n\nThe enhanced system is fully backward compatible:\n\n1. **Existing Users**: Continue to work without interruption\n2. **Legacy API**: Still supported for single exercise generation\n3. **Gradual Migration**: New features activate automatically when database is ready\n\n## Support\n\nIf you encounter issues:\n\n1. Check this setup guide\n2. Review the troubleshooting section\n3. Run the validation commands\n4. Check application logs for detailed error messages\n\n## Success Metrics\n\nAfter successful setup, you should see:\n\n- ⚡ **90% reduction** in API calls to Claude\n- 🚀 **Sub-200ms** loading between questions\n- 📚 **Growing database** of exercises for all users\n- 🌍 **Multilingual** explanations in 3 languages\n- 📊 **Smart fallback** ensuring 99.9% question availability\n\nThe enhanced system is now ready to provide a significantly improved learning experience!"